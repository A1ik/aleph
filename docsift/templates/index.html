{% extends "layout.html" %}
{% from '_pager.html' import pagination %}

{% block title %}
  {{query or "Search"}}
{% endblock %}

{% block content %}
  <div class="row search-area">
    <div class="col-md-8">
      <form class="form-horizontal" role="form" action="{{url_for('index')}}">
        <div class="input-group">
          <input name="query" type="text" class="form-control" id="query"
            value="{{query}}" autofocus placeholder="Search the document stash">
          <span class="input-group-btn">
            <button type="submit" class="btn btn-default">Search</button>
          </span>
        </div>
      </form>
    </div>
    <div class="col-md-4">
      <a class="btn btn-default" href="/export{{query_state()}}">Export results to Excel</a>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6">
      <ul class="results">
        {% for result in pager %}
          <li class="result" data-collection="{{result.es_meta.type}}" data-hash="{{result.es_meta.id}}">
            <span class="title">
              <a href="{{ result | details_url }}">
              {{result | field('title') | decode | truncate(70, True) }}
              </a>
            </span>
            {% if mapped(result, 'source_url') %}
              <span class="source">
                <a href="{{mapped(result, 'source_url')}}">{{ mapped(result, 'source_url') | truncate(80, True) }}</a>
                (<a href="{{result | download_url }}">local copy</a>)
              </span>
            {% endif %}
            <p class="teaser">
              {{result | field('text') | truncate(200) | or('No body text is available.') }}
            </p>
          </li>
        {% endfor %}
      </ul>

      {{ pagination(pager) }}
    </div>
    <div class="col-md-6" id="sidebar">
      <div class="row">
        {% for facet, filter, title in facets %}
          <div class="col-md-6">
            <h4>{{title}}</h4>
            <ul class="list-group">
              {% for res in facet_counts[facet] %}
              <li class="list-group-item">
                <span class="badge">{{res.count}}</span>
                {% if pager.has_url_state(filter, res.term) %}
                  <a class="facet-active" href="{{pager.remove_url_state(filter, res.term)}}">{{res.term}}</a>
                {% else %}
                  <a href="{{pager.add_url_state(filter, res.term)}}">{{res.term}}</a>
                {% endif %}
              </li>
            {% endfor %}
            </ul>
          </div>
        {% endfor %}
      </div>
    </div>

    <script id="details-sidebar" type="text/plain">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">
            Details
            <a class="close close-details">&times;</a>
          </h3>
        </div>
        <div class="panel-body">
          TABLE
        </div>
      </div>
    </script>
  </div>
{% endblock %}

